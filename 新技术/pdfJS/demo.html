<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/pdf.js/2.8.335/pdf.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/pdf.js/2.8.335/pdf.worker.js"></script>
</head>
<body>
    <img id="img" alt="" width="100%" height="auto">
	<canvas id="the-canvas" style="display: none"></canvas>
    <script>

        //url参数是pdf地址，imgUrl是最后的base64格式图片
        function showPdf(url){
            let _this = this;
            let imgArr = [];
            pdfjsLib.workerSrc = 'pdf.worker.js';
            let loadingTask = pdfjsLib.getDocument(url);
            // PDFJS.workerSrc = 'pdf.worker.js';// pdfjsLib为undefined可以换成这行
            // let loadingTask = PDFJS.getDocument(url);// pdfjsLib为undefined可以换成这行
            loadingTask.promise.then(function(pdf) {
                console.log('PDF loaded');
                let pageNum = pdf.numPages;
                // console.log(pageNum);
                for (let i=1; i<=pageNum; i++) {
                    pdf.getPage(i).then(function(page) {
                        console.log('Page loaded');

                        let scale = 1;
                        let viewport = page.getViewport(scale);

                        // let canvas = document.getElementById('the-canvas');
                        let canvas = document.createElement("canvas");
                        let context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        let renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        let renderTask = page.render(renderContext);
                        renderTask.then(function () {
                            console.log('Page rendered');
                            let imgUrl = canvas.toDataURL('image/jpeg'); //转换为base64
                            if (imgUrl) {
                                imgArr[i-1] = imgUrl;
                            }
                            //pdf全部画完结束后操作
                            if (imgArr.length==pageNum&&!isEmpty(imgArr)) {
                                // let canvas2 = document.createElement("canvas");
                                let canvas2 = document.getElementById('the-canvas');
                                let context2 = canvas2.getContext('2d');
                                canvas2.height = viewport.height*pageNum;
                                canvas2.width = viewport.width;
                                let count = 0;
                                for (let j=0; j<imgArr.length; j++) {
                                    let IMG = new Image();
                                    IMG.src=imgArr[j];
                                    IMG.width = viewport.width;
                                    IMG.height = viewport.height;
                                    IMG.onload = function () {
                                        context2.drawImage(IMG,0,viewport.height*j);
                                        count++;//确保所有img渲染结束后操作
                                        if (count==pageNum) {
                                            let canvas = document.getElementById('the-canvas');
                                            const imgNode = document.getElementById('img')
                                            //赋值给img
                                            imgNode.src = canvas.toDataURL('image/jpeg'); 
                                        }
                                    }
                                }
                            }
                        });
                    });
                }
            }, function (reason) {
                console.error(reason);
            });

            function isEmpty(arr) {
                for(let i=0;i<arr.length;i++) {
                    if(!arr[i])
                        return true;
                }
                return false;
            }
        }

        showPdf('./test.pdf')
    </script>
</body>
</html>